# 性能监控方案

## 一、文档概述
- **文档版本**：1.0
- **适用范围**：个人网站项目运维团队
- **监控目标**：实时监控系统性能、快速发现问题、保障服务稳定

## 二、监控架构设计

### 2.1 监控体系架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   应用监控      │    │   基础设施监控   │    │   业务监控      │
│   (APM)        │    │   (Infrastructure)│   │   (Business)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   监控平台      │
                    │   (Grafana)     │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │   告警系统      │
                    │   (AlertManager)│
                    └─────────────────┘
```

### 2.2 技术栈选择
- **指标收集**：Prometheus
- **日志收集**：ELK Stack (Elasticsearch + Logstash + Kibana)
- **可视化**：Grafana
- **告警**：AlertManager + 钉钉/邮件
- **链路追踪**：Jaeger
- **应用监控**：Node.js自定义指标

## 三、应用性能监控(APM)

### 3.1 Node.js应用监控
```javascript
// 性能监控中间件
const prometheus = require('prom-client');

// 创建指标收集器
const httpRequestDuration = new prometheus.Histogram({
  name: 'http_request_duration_seconds',
  help: 'HTTP请求响应时间',
  labelNames: ['method', 'route', 'status_code'],
  buckets: [0.1, 0.3, 0.5, 0.7, 1, 3, 5, 7, 10]
});

const httpRequestTotal = new prometheus.Counter({
  name: 'http_requests_total',
  help: 'HTTP请求总数',
  labelNames: ['method', 'route', 'status_code']
});

const activeConnections = new prometheus.Gauge({
  name: 'active_connections',
  help: '当前活跃连接数'
});

// 监控中间件
const monitoringMiddleware = (req, res, next) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = (Date.now() - start) / 1000;
    const route = req.route ? req.route.path : req.path;
    
    httpRequestDuration
      .labels(req.method, route, res.statusCode)
      .observe(duration);
      
    httpRequestTotal
      .labels(req.method, route, res.statusCode)
      .inc();
  });
  
  next();
};

// 应用到Express
app.use(monitoringMiddleware);

// 暴露指标端点
app.get('/metrics', (req, res) => {
  res.set('Content-Type', prometheus.register.contentType);
  res.end(prometheus.register.metrics());
});
```

### 3.2 数据库性能监控
```javascript
// MongoDB监控
const mongoose = require('mongoose');

// 连接池监控
const dbConnectionGauge = new prometheus.Gauge({
  name: 'mongodb_connections',
  help: 'MongoDB连接数',
  labelNames: ['state']
});

// 查询性能监控
const dbQueryDuration = new prometheus.Histogram({
  name: 'mongodb_query_duration_seconds',
  help: 'MongoDB查询响应时间',
  labelNames: ['collection', 'operation'],
  buckets: [0.01, 0.05, 0.1, 0.3, 0.5, 1, 3, 5]
});

// 监控查询性能
mongoose.set('debug', (collectionName, method, query, doc) => {
  const start = Date.now();
  
  // 记录查询开始
  process.nextTick(() => {
    const duration = (Date.now() - start) / 1000;
    dbQueryDuration
      .labels(collectionName, method)
      .observe(duration);
  });
});

// 定期收集连接池状态
setInterval(() => {
  const connections = mongoose.connection.db.serverConfig.connections();
  dbConnectionGauge.labels('available').set(connections.available);
  dbConnectionGauge.labels('used').set(connections.used);
}, 30000);
```

### 3.3 Redis性能监控
```javascript
// Redis监控
const redis = require('redis');
const client = redis.createClient();

const redisCommandDuration = new prometheus.Histogram({
  name: 'redis_command_duration_seconds',
  help: 'Redis命令响应时间',
  labelNames: ['command'],
  buckets: [0.001, 0.005, 0.01, 0.05, 0.1, 0.3, 0.5, 1]
});

const redisConnectionGauge = new prometheus.Gauge({
  name: 'redis_connections',
  help: 'Redis连接数'
});

// 包装Redis命令
const originalSend = client.send_command;
client.send_command = function(command, args, callback) {
  const start = Date.now();
  
  const wrappedCallback = function(...callbackArgs) {
    const duration = (Date.now() - start) / 1000;
    redisCommandDuration.labels(command).observe(duration);
    
    if (callback) {
      callback.apply(this, callbackArgs);
    }
  };
  
  return originalSend.call(this, command, args, wrappedCallback);
};
```

## 四、基础设施监控

### 4.1 系统资源监控
```yaml
# Prometheus配置 (prometheus.yml)
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

scrape_configs:
  # Node Exporter (系统指标)
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']
    scrape_interval: 15s
    
  # 应用指标
  - job_name: 'personal-website'
    static_configs:
      - targets: ['localhost:8000']
    metrics_path: '/metrics'
    scrape_interval: 15s
    
  # MongoDB Exporter
  - job_name: 'mongodb'
    static_configs:
      - targets: ['localhost:9216']
    scrape_interval: 30s
    
  # Redis Exporter
  - job_name: 'redis'
    static_configs:
      - targets: ['localhost:9121']
    scrape_interval: 30s

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

### 4.2 告警规则配置
```yaml
# alert_rules.yml
groups:
  - name: system_alerts
    rules:
      # CPU使用率告警
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU使用率过高"
          description: "实例 {{ $labels.instance }} CPU使用率超过80%，当前值: {{ $value }}%"
      
      # 内存使用率告警
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "内存使用率过高"
          description: "实例 {{ $labels.instance }} 内存使用率超过85%，当前值: {{ $value }}%"
      
      # 磁盘空间告警
      - alert: HighDiskUsage
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "磁盘空间不足"
          description: "实例 {{ $labels.instance }} 磁盘使用率超过90%，当前值: {{ $value }}%"

  - name: application_alerts
    rules:
      # HTTP错误率告警
      - alert: HighErrorRate
        expr: rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100 > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "HTTP错误率过高"
          description: "5xx错误率超过5%，当前值: {{ $value }}%"
      
      # 响应时间告警
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "响应时间过长"
          description: "95%分位响应时间超过2秒，当前值: {{ $value }}秒"
      
      # 数据库连接告警
      - alert: DatabaseConnectionHigh
        expr: mongodb_connections{state="used"} / mongodb_connections{state="available"} * 100 > 80
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "数据库连接使用率过高"
          description: "MongoDB连接使用率超过80%，当前值: {{ $value }}%"
```

## 五、日志监控

### 5.1 日志收集配置
```javascript
// Winston日志配置
const winston = require('winston');
const { ElasticsearchTransport } = require('winston-elasticsearch');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: {
    service: 'personal-website',
    version: process.env.APP_VERSION || '1.0.0'
  },
  transports: [
    // 控制台输出
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    }),
    
    // 文件输出
    new winston.transports.File({
      filename: 'logs/error.log',
      level: 'error',
      maxsize: 10485760, // 10MB
      maxFiles: 5
    }),
    
    new winston.transports.File({
      filename: 'logs/combined.log',
      maxsize: 10485760,
      maxFiles: 10
    }),
    
    // Elasticsearch输出
    new ElasticsearchTransport({
      level: 'info',
      clientOpts: {
        node: process.env.ELASTICSEARCH_URL || 'http://localhost:9200'
      },
      index: 'personal-website-logs'
    })
  ]
});

// 结构化日志记录
const logRequest = (req, res, next) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - start;
    
    logger.info('HTTP Request', {
      method: req.method,
      url: req.url,
      statusCode: res.statusCode,
      duration,
      userAgent: req.get('User-Agent'),
      ip: req.ip,
      userId: req.user?.id
    });
  });
  
  next();
};

module.exports = { logger, logRequest };
```

### 5.2 错误日志监控
```javascript
// 错误处理中间件
const errorHandler = (err, req, res, next) => {
  // 记录错误日志
  logger.error('Application Error', {
    error: {
      message: err.message,
      stack: err.stack,
      name: err.name
    },
    request: {
      method: req.method,
      url: req.url,
      headers: req.headers,
      body: req.body,
      params: req.params,
      query: req.query
    },
    user: req.user?.id,
    timestamp: new Date().toISOString()
  });
  
  // 发送错误响应
  res.status(err.statusCode || 500).json({
    code: err.statusCode || 500,
    message: process.env.NODE_ENV === 'production' 
      ? '服务器内部错误' 
      : err.message
  });
};

// 未捕获异常处理
process.on('uncaughtException', (err) => {
  logger.error('Uncaught Exception', {
    error: {
      message: err.message,
      stack: err.stack
    },
    timestamp: new Date().toISOString()
  });
  
  // 优雅关闭
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  logger.error('Unhandled Rejection', {
    reason,
    promise,
    timestamp: new Date().toISOString()
  });
});
```

## 六、业务监控

### 6.1 用户行为监控
```javascript
// 用户行为追踪
const trackUserAction = (action, userId, metadata = {}) => {
  logger.info('User Action', {
    action,
    userId,
    metadata,
    timestamp: new Date().toISOString(),
    type: 'USER_BEHAVIOR'
  });
  
  // 发送到分析系统
  analytics.track(userId, action, metadata);
};

// 业务指标收集
const businessMetrics = {
  // 用户注册
  userRegistration: new prometheus.Counter({
    name: 'user_registrations_total',
    help: '用户注册总数'
  }),
  
  // 文章发布
  articlePublished: new prometheus.Counter({
    name: 'articles_published_total',
    help: '文章发布总数'
  }),
  
  // 游戏游玩
  gamePlay: new prometheus.Counter({
    name: 'game_plays_total',
    help: '游戏游玩次数',
    labelNames: ['game_id']
  }),
  
  // 在线用户数
  onlineUsers: new prometheus.Gauge({
    name: 'online_users',
    help: '当前在线用户数'
  })
};

// 使用示例
app.post('/api/auth/register', async (req, res) => {
  try {
    const user = await userService.createUser(req.body);
    
    // 记录业务指标
    businessMetrics.userRegistration.inc();
    trackUserAction('user_register', user.id, {
      email: user.email,
      source: req.get('Referer')
    });
    
    res.json({ code: 200, data: user });
  } catch (error) {
    next(error);
  }
});
```

### 6.2 性能指标监控
```javascript
// 自定义性能指标
const performanceMetrics = {
  // 数据库查询性能
  dbQueryPerformance: new prometheus.Histogram({
    name: 'db_query_performance_seconds',
    help: '数据库查询性能',
    labelNames: ['operation', 'collection'],
    buckets: [0.01, 0.05, 0.1, 0.3, 0.5, 1, 3, 5]
  }),
  
  // 缓存命中率
  cacheHitRate: new prometheus.Gauge({
    name: 'cache_hit_rate',
    help: '缓存命中率',
    labelNames: ['cache_type']
  }),
  
  // 文件上传性能
  fileUploadDuration: new prometheus.Histogram({
    name: 'file_upload_duration_seconds',
    help: '文件上传耗时',
    labelNames: ['file_type'],
    buckets: [0.1, 0.5, 1, 3, 5, 10, 30]
  })
};

// 缓存监控装饰器
const monitorCache = (cacheType) => {
  return (target, propertyName, descriptor) => {
    const method = descriptor.value;
    
    descriptor.value = async function(...args) {
      const start = Date.now();
      let hit = false;
      
      try {
        const result = await method.apply(this, args);
        hit = result !== null && result !== undefined;
        return result;
      } finally {
        const duration = (Date.now() - start) / 1000;
        performanceMetrics.cacheHitRate
          .labels(cacheType)
          .set(hit ? 1 : 0);
      }
    };
    
    return descriptor;
  };
};
```

## 七、监控仪表板

### 7.1 Grafana仪表板配置
```json
{
  "dashboard": {
    "title": "个人网站监控仪表板",
    "panels": [
      {
        "title": "HTTP请求QPS",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{route}}"
          }
        ]
      },
      {
        "title": "响应时间分布",
        "type": "heatmap",
        "targets": [
          {
            "expr": "rate(http_request_duration_seconds_bucket[5m])",
            "legendFormat": "{{le}}"
          }
        ]
      },
      {
        "title": "错误率",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(http_requests_total{status_code=~\"5..\"}[5m]) / rate(http_requests_total[5m]) * 100",
            "legendFormat": "5xx错误率"
          }
        ]
      },
      {
        "title": "系统资源使用率",
        "type": "graph",
        "targets": [
          {
            "expr": "100 - (avg(irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)",
            "legendFormat": "CPU使用率"
          },
          {
            "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100",
            "legendFormat": "内存使用率"
          }
        ]
      }
    ]
  }
}
```

## 八、告警通知

### 8.1 AlertManager配置
```yaml
# alertmanager.yml
global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@example.com'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'

receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://localhost:3001/webhook/dingtalk'
        send_resolved: true
    
  - name: 'email'
    email_configs:
      - to: 'admin@example.com'
        subject: '【告警】{{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          告警名称: {{ .Annotations.summary }}
          告警详情: {{ .Annotations.description }}
          告警时间: {{ .StartsAt }}
          {{ end }}

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'dev', 'instance']
```

### 8.2 钉钉告警集成
```javascript
// 钉钉Webhook告警
const axios = require('axios');

const sendDingTalkAlert = async (alerts) => {
  const webhook = process.env.DINGTALK_WEBHOOK;
  
  for (const alert of alerts) {
    const message = {
      msgtype: 'markdown',
      markdown: {
        title: `【${alert.status === 'firing' ? '告警' : '恢复'}】${alert.labels.alertname}`,
        text: `
### ${alert.status === 'firing' ? '🚨 告警' : '✅ 恢复'}: ${alert.labels.alertname}

**告警详情**: ${alert.annotations.description}

**告警时间**: ${new Date(alert.startsAt).toLocaleString()}

**实例**: ${alert.labels.instance}

**严重程度**: ${alert.labels.severity}
        `
      }
    };
    
    try {
      await axios.post(webhook, message);
    } catch (error) {
      console.error('发送钉钉告警失败:', error);
    }
  }
};

// Webhook接收端点
app.post('/webhook/dingtalk', (req, res) => {
  const { alerts } = req.body;
  
  if (alerts && alerts.length > 0) {
    sendDingTalkAlert(alerts);
  }
  
  res.status(200).send('OK');
});
```

## 九、监控运维

### 9.1 监控系统部署
```yaml
# docker-compose.monitoring.yml
version: '3.8'
services:
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./alert_rules.yml:/etc/prometheus/alert_rules.yml
    
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
    volumes:
      - grafana_data:/var/lib/grafana
    
  alertmanager:
    image: prom/alertmanager:latest
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
    
  node-exporter:
    image: prom/node-exporter:latest
    ports:
      - "9100:9100"
    
  elasticsearch:
    image: elasticsearch:7.14.0
    environment:
      - discovery.type=single-node
    ports:
      - "9200:9200"
    
  kibana:
    image: kibana:7.14.0
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch

volumes:
  grafana_data:
```

### 9.2 监控数据备份
```bash
#!/bin/bash
# backup_monitoring.sh

# 备份Prometheus数据
docker exec prometheus tar -czf /tmp/prometheus_backup.tar.gz /prometheus

# 备份Grafana配置
docker exec grafana tar -czf /tmp/grafana_backup.tar.gz /var/lib/grafana

# 上传到云存储
aws s3 cp /tmp/prometheus_backup.tar.gz s3://monitoring-backup/$(date +%Y%m%d)/
aws s3 cp /tmp/grafana_backup.tar.gz s3://monitoring-backup/$(date +%Y%m%d)/

# 清理本地备份文件
rm -f /tmp/*_backup.tar.gz
```

## 十、监控优化

### 10.1 性能优化
- **指标采集频率**：根据重要性调整采集间隔
- **数据保留策略**：设置合理的数据保留期限
- **查询优化**：优化Prometheus查询语句
- **存储优化**：使用时序数据库压缩

### 10.2 告警优化
- **告警收敛**：避免告警风暴
- **智能告警**：基于历史数据的动态阈值
- **告警分级**：不同级别采用不同通知方式
- **静默规则**：维护期间自动静默告警
