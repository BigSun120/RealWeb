# 安全策略文档

## 一、文档概述
- **文档版本**：1.0
- **适用范围**：个人网站项目开发团队
- **安全目标**：确保用户数据安全、防范常见网络攻击、建立安全开发流程

## 二、认证与授权安全

### 2.1 用户认证策略
- **密码策略**：
  - 最小长度：8位
  - 必须包含：大写字母、小写字母、数字、特殊符号
  - 禁用常见弱密码（123456、password等）
  - 密码历史：不能与最近3次密码相同

- **登录安全**：
  - 连续失败5次后锁定账户30分钟
  - 异地登录邮件通知
  - 可疑登录行为检测

### 2.2 JWT Token安全
```javascript
// JWT配置
const jwtConfig = {
  secret: process.env.JWT_SECRET, // 256位随机密钥
  expiresIn: '24h',              // 访问令牌24小时过期
  refreshExpiresIn: '7d',        // 刷新令牌7天过期
  algorithm: 'HS256'             // HMAC SHA256算法
};

// Token刷新机制
const refreshToken = {
  autoRefresh: true,             // 自动刷新
  refreshThreshold: '2h',        // 剩余2小时时刷新
  maxRefreshCount: 10            // 最大刷新次数
};
```

### 2.3 权限控制(RBAC)
```javascript
// 角色定义
const roles = {
  admin: {
    permissions: ['*'], // 所有权限
    description: '管理员'
  },
  user: {
    permissions: [
      'article:read',
      'article:create',
      'article:update:own',
      'article:delete:own',
      'comment:create',
      'comment:delete:own',
      'game:play',
      'score:submit'
    ],
    description: '普通用户'
  },
  guest: {
    permissions: [
      'article:read',
      'game:play'
    ],
    description: '游客'
  }
};
```

## 三、输入验证与数据安全

### 3.1 输入验证规则
```javascript
// 用户注册验证
const registerValidation = {
  username: {
    type: 'string',
    minLength: 3,
    maxLength: 15,
    pattern: /^[a-zA-Z0-9_]+$/,
    required: true
  },
  email: {
    type: 'email',
    maxLength: 100,
    required: true
  },
  password: {
    type: 'string',
    minLength: 8,
    maxLength: 50,
    pattern: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]/,
    required: true
  }
};

// 文章内容验证
const articleValidation = {
  title: {
    type: 'string',
    minLength: 1,
    maxLength: 100,
    required: true,
    sanitize: true // HTML标签过滤
  },
  content: {
    type: 'string',
    minLength: 10,
    maxLength: 50000,
    required: true,
    allowedTags: ['h1', 'h2', 'h3', 'p', 'strong', 'em', 'ul', 'ol', 'li', 'a', 'img', 'code', 'pre']
  }
};
```

### 3.2 XSS防护
```javascript
// 内容过滤中间件
const xssProtection = {
  // HTML标签白名单
  allowedTags: ['h1', 'h2', 'h3', 'p', 'strong', 'em', 'ul', 'ol', 'li', 'a', 'img', 'code', 'pre'],
  
  // 属性白名单
  allowedAttributes: {
    'a': ['href', 'title'],
    'img': ['src', 'alt', 'title', 'width', 'height']
  },
  
  // URL协议白名单
  allowedSchemes: ['http', 'https', 'mailto'],
  
  // 自动转义
  escapeHtml: true
};

// 使用DOMPurify进行内容清理
const sanitizeContent = (content) => {
  return DOMPurify.sanitize(content, xssProtection);
};
```

### 3.3 SQL注入防护
```javascript
// MongoDB查询参数化
const findUserByEmail = async (email) => {
  // 正确方式：使用参数化查询
  return await User.findOne({ email: email });
  
  // 错误方式：字符串拼接（容易注入）
  // return await User.findOne({ $where: `this.email == '${email}'` });
};

// 输入类型验证
const validateObjectId = (id) => {
  if (!mongoose.Types.ObjectId.isValid(id)) {
    throw new Error('Invalid ObjectId format');
  }
  return id;
};
```

## 四、文件上传安全

### 4.1 文件类型限制
```javascript
const fileUploadConfig = {
  // 允许的文件类型
  allowedMimeTypes: [
    'image/jpeg',
    'image/png',
    'image/gif',
    'image/webp'
  ],
  
  // 文件大小限制
  maxFileSize: 5 * 1024 * 1024, // 5MB
  
  // 文件名规则
  fileNamePattern: /^[a-zA-Z0-9_\-\.]+$/,
  
  // 上传目录
  uploadDir: './uploads',
  
  // 病毒扫描
  virusScan: true
};

// 文件验证中间件
const validateFile = (file) => {
  // 检查文件类型
  if (!fileUploadConfig.allowedMimeTypes.includes(file.mimetype)) {
    throw new Error('不支持的文件类型');
  }
  
  // 检查文件大小
  if (file.size > fileUploadConfig.maxFileSize) {
    throw new Error('文件大小超出限制');
  }
  
  // 检查文件名
  if (!fileUploadConfig.fileNamePattern.test(file.originalname)) {
    throw new Error('文件名包含非法字符');
  }
  
  return true;
};
```

### 4.2 图片处理安全
```javascript
// 图片处理配置
const imageProcessing = {
  // 移除EXIF信息
  removeExif: true,
  
  // 图片尺寸限制
  maxWidth: 2048,
  maxHeight: 2048,
  
  // 压缩质量
  quality: 80,
  
  // 格式转换
  convertToWebP: true
};
```

## 五、API安全

### 5.1 请求频率限制
```javascript
// 全局限流配置
const globalRateLimit = {
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 1000,                // 最多1000次请求
  message: '请求过于频繁，请稍后再试'
};

// 登录接口限流
const loginRateLimit = {
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 5,                   // 最多5次登录尝试
  skipSuccessfulRequests: true
};

// 文章发布限流
const articleRateLimit = {
  windowMs: 60 * 60 * 1000, // 1小时
  max: 10,                  // 最多发布10篇文章
  keyGenerator: (req) => req.user.id
};
```

### 5.2 CORS配置
```javascript
const corsConfig = {
  origin: [
    'http://localhost:3000',
    'https://yourdomain.com'
  ],
  credentials: true,
  optionsSuccessStatus: 200,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH'],
  allowedHeaders: ['Content-Type', 'Authorization']
};
```

### 5.3 CSRF防护
```javascript
// CSRF Token配置
const csrfConfig = {
  secret: process.env.CSRF_SECRET,
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict'
  }
};
```

## 六、数据加密与存储

### 6.1 密码加密
```javascript
const bcrypt = require('bcrypt');

// 密码加密
const hashPassword = async (password) => {
  const saltRounds = 12;
  return await bcrypt.hash(password, saltRounds);
};

// 密码验证
const verifyPassword = async (password, hashedPassword) => {
  return await bcrypt.compare(password, hashedPassword);
};
```

### 6.2 敏感数据加密
```javascript
const crypto = require('crypto');

// AES-256-GCM加密
const encrypt = (text, key) => {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipher('aes-256-gcm', key, iv);
  
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  const authTag = cipher.getAuthTag();
  
  return {
    encrypted,
    iv: iv.toString('hex'),
    authTag: authTag.toString('hex')
  };
};
```

## 七、日志与监控

### 7.1 安全日志记录
```javascript
// 安全事件日志
const securityLogger = {
  // 登录失败
  loginFailure: (ip, email, reason) => {
    logger.warn('Login failure', {
      ip,
      email,
      reason,
      timestamp: new Date(),
      type: 'SECURITY_LOGIN_FAILURE'
    });
  },
  
  // 权限拒绝
  accessDenied: (userId, resource, action) => {
    logger.warn('Access denied', {
      userId,
      resource,
      action,
      timestamp: new Date(),
      type: 'SECURITY_ACCESS_DENIED'
    });
  },
  
  // 可疑活动
  suspiciousActivity: (userId, activity, details) => {
    logger.error('Suspicious activity', {
      userId,
      activity,
      details,
      timestamp: new Date(),
      type: 'SECURITY_SUSPICIOUS'
    });
  }
};
```

### 7.2 实时监控告警
```javascript
// 安全监控规则
const securityMonitoring = {
  // 异常登录检测
  abnormalLogin: {
    enabled: true,
    threshold: 5,        // 5次失败后告警
    timeWindow: 300,     // 5分钟内
    action: 'block_ip'   // 封禁IP
  },
  
  // 大量请求检测
  ddosDetection: {
    enabled: true,
    threshold: 100,      // 100次请求/分钟
    timeWindow: 60,
    action: 'rate_limit'
  },
  
  // 文件上传异常
  uploadAnomaly: {
    enabled: true,
    maxFileSize: 10485760, // 10MB
    action: 'reject'
  }
};
```

## 八、安全开发规范

### 8.1 代码审查清单
- [ ] 输入验证是否完整
- [ ] 是否存在SQL注入风险
- [ ] 是否存在XSS漏洞
- [ ] 权限检查是否正确
- [ ] 敏感信息是否加密
- [ ] 错误信息是否泄露敏感数据
- [ ] 日志记录是否充分

### 8.2 安全测试
```javascript
// 安全测试用例
describe('Security Tests', () => {
  test('应该防止SQL注入', async () => {
    const maliciousInput = "'; DROP TABLE users; --";
    const response = await request(app)
      .post('/api/users/search')
      .send({ query: maliciousInput });
    
    expect(response.status).toBe(400);
  });
  
  test('应该过滤XSS攻击', async () => {
    const xssPayload = '<script>alert("xss")</script>';
    const response = await request(app)
      .post('/api/articles')
      .send({ title: xssPayload });
    
    expect(response.body.data.title).not.toContain('<script>');
  });
});
```

## 九、应急响应

### 9.1 安全事件响应流程
1. **发现阶段**：监控系统检测到异常
2. **分析阶段**：确认是否为安全事件
3. **遏制阶段**：立即阻止攻击继续
4. **根除阶段**：修复漏洞，清除威胁
5. **恢复阶段**：恢复正常服务
6. **总结阶段**：事后分析，改进措施

### 9.2 紧急联系方式
- **技术负责人**：[联系方式]
- **安全负责人**：[联系方式]
- **运维负责人**：[联系方式]

## 十、合规要求

### 10.1 数据保护
- 用户数据最小化收集
- 明确的隐私政策
- 用户数据删除权
- 数据传输加密

### 10.2 审计要求
- 完整的操作日志
- 定期安全评估
- 漏洞扫描报告
- 安全培训记录
