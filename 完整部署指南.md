# ğŸš€ Ubuntu 21.04 å®Œæ•´éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç³»ç»Ÿè¦æ±‚
- Ubuntu 22.04 x64 (æ¨èLTSç‰ˆæœ¬) 
- 2GB+ å†…å­˜
- 20GB+ ç¡¬ç›˜ç©ºé—´
- å…¬ç½‘IPå’ŒåŸŸå

## ğŸ”§ ç¬¬ä¸€æ­¥ï¼šç³»ç»Ÿåˆå§‹åŒ–

### 1.1 æ›´æ–°ç³»ç»Ÿ
```bash
# æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨ ok
sudo apt update && sudo apt upgrade -y 

# å®‰è£…åŸºç¡€å·¥å…· ok
sudo apt install -y curl wget git vim htop unzip ca-certificates gnupg lsb-release software-properties-common

# éªŒè¯ç³»ç»Ÿç‰ˆæœ¬ ok
lsb_release -a
```

### 1.2 é…ç½®æ—¶åŒº
```bash
# è®¾ç½®æ—¶åŒºä¸ºä¸­å›½
sudo timedatectl set-timezone Asia/Shanghai

# éªŒè¯æ—¶é—´
date
```

### 1.3 é…ç½®é˜²ç«å¢™
```bash
# å¯ç”¨UFWé˜²ç«å¢™ ok
sudo ufw --force enable
sudo ufw default deny incoming
sudo ufw default allow outgoing

# å¼€æ”¾å¿…è¦ç«¯å£ ok
sudo ufw allow ssh
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 25/tcp    # SMTP
sudo ufw allow 2500/tcp  # Inbucket SMTP

# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
sudo ufw status
```

## ğŸ³ ç¬¬äºŒæ­¥ï¼šå®‰è£…Docker

### 2.1 å®‰è£…Docker
```bash
# å¸è½½æ—§ç‰ˆæœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
sudo apt remove -y docker docker-engine docker.io containerd runc

# æ·»åŠ Dockerå®˜æ–¹GPGå¯†é’¥ ok
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

# æ·»åŠ Dockerä»“åº“ ok
echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# æ›´æ–°åŒ…åˆ—è¡¨å¹¶å®‰è£…Docker ok
sudo apt update
sudo apt install -y docker-ce docker-ce-cli containerd.io

# å¯åŠ¨DockeræœåŠ¡ ok
sudo systemctl start docker
sudo systemctl enable docker

# å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°dockerç»„
sudo usermod -aG docker $USER

# é‡æ–°ç™»å½•ä»¥ä½¿ç»„æƒé™ç”Ÿæ•ˆ
newgrp docker

# éªŒè¯Dockerå®‰è£… ok
docker --version
docker run hello-world
```

### 2.2 å®‰è£…Docker Compose
```bash
# ä¸‹è½½Docker Compose ok
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose

# æ·»åŠ æ‰§è¡Œæƒé™
sudo chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£… ok
docker-compose --version
```

### 2.3 é…ç½®Dockeré•œåƒåŠ é€Ÿï¼ˆè§£å†³HTTPSä¸‹è½½é—®é¢˜ï¼‰
```bash
# åˆ›å»ºDockeré…ç½®ç›®å½•
sudo mkdir -p /etc/docker

# é…ç½®é•œåƒåŠ é€Ÿå™¨
sudo tee /etc/docker/daemon.json <<EOF
{
  "registry-mirrors": [
    "https://docker.m.daocloud.io",
    "https://dockerproxy.com",
    "https://mirror.ccs.tencentyun.com"
  ],
  "insecure-registries": [],
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
EOF

# é‡å¯DockeræœåŠ¡
sudo systemctl daemon-reload
sudo systemctl restart docker

# éªŒè¯é…ç½®
docker info | grep -A5 "Registry Mirrors"
```

## ğŸŒ ç¬¬ä¸‰æ­¥ï¼šåŸŸåå’ŒSSLé…ç½®

### 3.1 å®‰è£…Certbot ok
```bash
# å®‰è£…Certbot
sudo apt install -y certbot

# éªŒè¯å®‰è£…
certbot --version
```

### 3.2 è·å–SSLè¯ä¹¦
```bash
# æ›¿æ¢ your-domain.com ä¸ºæ‚¨çš„å®é™…åŸŸå ok
DOMAIN="godaug.fun"

# è·å–SSLè¯ä¹¦ âœ… å·²å®Œæˆ
# æ³¨æ„ï¼šå¦‚æœ80ç«¯å£è¢«å ç”¨ï¼Œéœ€è¦å…ˆåœæ­¢ç›¸å…³æœåŠ¡ï¼ˆå¦‚nginxï¼‰
sudo systemctl stop nginx  # ä¸´æ—¶åœæ­¢nginx
sudo certbot certonly --standalone -d $DOMAIN -d www.$DOMAIN
sudo systemctl start nginx  # é‡æ–°å¯åŠ¨nginx

# è¯ä¹¦æ–‡ä»¶ä½ç½®ï¼š
# è¯ä¹¦æ–‡ä»¶: /etc/letsencrypt/live/godaug.fun/fullchain.pem
# ç§é’¥æ–‡ä»¶: /etc/letsencrypt/live/godaug.fun/privkey.pemprivkey.pem
# - è¿‡æœŸæ—¶é—´: 2025-11-17ï¼ˆè‡ªåŠ¨ç»­æœŸå·²è®¾ç½®ï¼‰

# éªŒè¯è¯ä¹¦
sudo ls -la /etc/letsencrypt/live/$DOMAIN/
```

## ğŸ“ ç¬¬å››æ­¥ï¼šé¡¹ç›®éƒ¨ç½²

### 4.1 åˆ›å»ºé¡¹ç›®ç›®å½• ok
```bash
# åˆ›å»ºé¡¹ç›®ç›®å½•
mkdir -p ~/temp-email-system
cd ~/temp-email-system

# åˆ›å»ºå¿…è¦çš„å­ç›®å½•
mkdir -p ssl logs nginx backend frontend
```

### 4.2 å¤åˆ¶SSLè¯ä¹¦ ok
```bash
# å¤åˆ¶è¯ä¹¦æ–‡ä»¶åˆ°é¡¹ç›®ç›®å½•
sudo cp /etc/letsencrypt/live/$DOMAIN/fullchain.pem ssl/
sudo cp /etc/letsencrypt/live/$DOMAIN/privkey.pem ssl/
sudo chown -R $USER:$USER ssl/

# éªŒè¯è¯ä¹¦æ–‡ä»¶ ok
ls -la ssl/
```

### 4.3 åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶ ok
```bash
# åˆ›å»ºç”Ÿäº§ç¯å¢ƒé…ç½®
cat > .env.prod << EOF
NODE_ENV=production
DOMAIN=$DOMAIN
SMTP_DOMAINS=$DOMAIN,localhost,test.local
PORT=8000
EOF
```

## ğŸ”§ ç¬¬äº”æ­¥ï¼šåˆ›å»ºé…ç½®æ–‡ä»¶

### 5.1 åˆ›å»ºDocker Composeé…ç½® 
```bash
cat > docker-compose.prod.yml << 'EOF'
version: '3.8'

services:
  # å‰ç«¯æœåŠ¡
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./frontend/nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - backend
    restart: unless-stopped
    networks:
      - app-network

  # åç«¯æœåŠ¡
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - NODE_ENV=production
      - PORT=8000
      - INBUCKET_API=http://inbucket:9000/api/v1
    depends_on:
      - inbucket
    restart: unless-stopped
    networks:
      - app-network
    volumes:
      - ./logs:/app/logs

  # é‚®ä»¶æœåŠ¡
  inbucket:
    image: docker.m.daocloud.io/inbucket/inbucket:latest
    ports:
      - "9000:9000"  # Webç•Œé¢
      - "2500:2500"  # SMTP
      - "1100:1100"  # POP3
    environment:
      - INBUCKET_SMTP_DOMAIN=your-domain.com,localhost,test.local
      - INBUCKET_SMTP_ADDR=0.0.0.0:2500
      - INBUCKET_WEB_ADDR=0.0.0.0:9000
      - INBUCKET_POP3_ADDR=0.0.0.0:1100
      - INBUCKET_WEB_CORSORIGIN=https://your-domain.com,http://localhost:3000
      - INBUCKET_STORAGE_TYPE=file
      - INBUCKET_STORAGE_PARAMS=/data
    volumes:
      - inbucket-data:/data
    restart: unless-stopped
    networks:
      - app-network

  # Redisç¼“å­˜
  redis:
    image: docker.m.daocloud.io/library/redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - app-network
    command: redis-server --appendonly yes

volumes:
  inbucket-data:
  redis-data:

networks:
  app-network:
    driver: bridge
EOF
```

### 5.2 æ›¿æ¢åŸŸåé…ç½® ok
```bash
# æ›¿æ¢é…ç½®æ–‡ä»¶ä¸­çš„åŸŸå 
sed -i "s/your-domain.com/$DOMAIN/g" docker-compose.prod.yml

### 5.3 åˆ›å»ºå‰ç«¯Nginxé…ç½® ok
```bash
mkdir -p frontend
cat > frontend/nginx.conf << 'EOF'
events {
    worker_connections 1024;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    # æ—¥å¿—æ ¼å¼
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;
    error_log /var/log/nginx/error.log;

    # åŸºæœ¬è®¾ç½®
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/javascript
        application/xml+rss
        application/json;

    # ä¸Šæ¸¸åç«¯æœåŠ¡
    upstream backend {
        server backend:8000;
    }

    # HTTPæœåŠ¡å™¨ï¼ˆé‡å®šå‘åˆ°HTTPSï¼‰
    server {
        listen 80;
        server_name your-domain.com www.your-domain.com;

        # Let's EncryptéªŒè¯
        location /.well-known/acme-challenge/ {
            root /var/www/certbot;
        }

        # é‡å®šå‘åˆ°HTTPS
        location / {
            return 301 https://$server_name$request_uri;
        }
    }

    # HTTPSæœåŠ¡å™¨
    server {
        listen 443 ssl http2;
        server_name your-domain.com www.your-domain.com;

        # SSLè¯ä¹¦é…ç½®
        ssl_certificate /etc/nginx/ssl/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/privkey.pem;

        # SSLå®‰å…¨é…ç½®
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;

        # å®‰å…¨å¤´
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

        # å‰ç«¯é™æ€æ–‡ä»¶
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
            try_files $uri $uri/ /index.html;

            # ç¼“å­˜è®¾ç½®
            location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                expires 1y;
                add_header Cache-Control "public, immutable";
            }
        }

        # APIä»£ç†
        location /api/ {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;

            # è¶…æ—¶è®¾ç½®
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # ä¸´æ—¶é‚®ç®±æœåŠ¡
        location /temp-email {
            proxy_pass http://backend/temp-email;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # å¥åº·æ£€æŸ¥
        location /health {
            proxy_pass http://backend/health;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # é™æ€èµ„æº
        location /uploads/ {
            alias /app/uploads/;
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
    }
}
EOF

# æ›¿æ¢nginxé…ç½®ä¸­çš„åŸŸå
sed -i "s/your-domain.com/$DOMAIN/g" frontend/nginx.conf
```

### 5.4 åˆ›å»ºå‰ç«¯Dockerfile ok
```bash
cat > frontend/Dockerfile.prod << 'EOF'
# æ„å»ºé˜¶æ®µ
FROM node:18-alpine AS builder

WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci --only=production

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºç”Ÿäº§ç‰ˆæœ¬
RUN npm run build

# ç”Ÿäº§é˜¶æ®µ
FROM nginx:alpine

# å¤åˆ¶æ„å»ºç»“æœ
COPY --from=builder /app/dist /usr/share/nginx/html

# å¤åˆ¶nginxé…ç½®
COPY nginx.conf /etc/nginx/nginx.conf

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p /var/www/certbot

# æš´éœ²ç«¯å£
EXPOSE 80 443

# å¯åŠ¨nginx
CMD ["nginx", "-g", "daemon off;"]
EOF
```

### 5.5 åˆ›å»ºåç«¯Dockerfile ok
```bash
cat > backend/Dockerfile << 'EOF'
FROM node:18-alpine

WORKDIR /app

# å¤åˆ¶packageæ–‡ä»¶
COPY package*.json ./

# å®‰è£…ä¾èµ–
RUN npm ci --only=production

# å¤åˆ¶æºä»£ç 
COPY . .

# åˆ›å»ºå¿…è¦ç›®å½•
RUN mkdir -p logs uploads

# æš´éœ²ç«¯å£
EXPOSE 8000

# å¯åŠ¨åº”ç”¨
CMD ["npm", "start"]
EOF
```

## ğŸš€ ç¬¬å…­æ­¥ï¼šéƒ¨ç½²åº”ç”¨

### 6.1 é¢„æ‹‰å–Dockeré•œåƒï¼ˆè§£å†³HTTPSä¸‹è½½é—®é¢˜ï¼‰  ok
```bash
# æ‹‰å–åŸºç¡€é•œåƒ
docker pull docker.m.daocloud.io/library/node:18-alpine            # ok
docker pull docker.m.daocloud.io/library/nginx:alpine             # ok
docker pull docker.m.daocloud.io/library/redis:7-alpine          # ok
docker pull docker.m.daocloud.io/inbucket/inbucket:latest      # ok

# ç»™é•œåƒæ‰“æ ‡ç­¾ï¼ˆè®©Docker Composeèƒ½æ‰¾åˆ°ï¼‰ ok
docker tag docker.m.daocloud.io/library/node:18-alpine node:18-alpine
docker tag docker.m.daocloud.io/library/nginx:alpine nginx:alpine
docker tag docker.m.daocloud.io/library/redis:7-alpine redis:7-alpine
docker tag docker.m.daocloud.io/inbucket/inbucket:latest inbucket/inbucket:latest

# éªŒè¯é•œåƒ
docker images
```

### 6.2 åˆ›å»ºåº”ç”¨ä»£ç ï¼ˆç¤ºä¾‹ï¼‰ ä½¿ç”¨é¡¹ç›®ä»£ç 
```bash
# åˆ›å»ºç®€å•çš„åç«¯åº”ç”¨
cat > backend/package.json << 'EOF'
{
  "name": "temp-email-backend",
  "version": "1.0.0",
  "main": "app.js",
  "scripts": {
    "start": "node app.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "axios": "^1.4.0"
  }
}
EOF

cat > backend/app.js << 'EOF'
const express = require('express');
const cors = require('cors');
const app = express();
const PORT = process.env.PORT || 8000;

app.use(cors());
app.use(express.json());

// å¥åº·æ£€æŸ¥
app.get('/health', (req, res) => {
    res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

// ä¸´æ—¶é‚®ç®±API
app.get('/temp-email', (req, res) => {
    res.json({ message: 'ä¸´æ—¶é‚®ç®±æœåŠ¡æ­£å¸¸è¿è¡Œ' });
});

app.listen(PORT, '0.0.0.0', () => {
    console.log(`æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ ${PORT}`);
});
EOF

# åˆ›å»ºç®€å•çš„å‰ç«¯åº”ç”¨ ä½¿ç”¨é¡¹ç›®ä»£ç 
cat > frontend/package.json << 'EOF'
{
  "name": "temp-email-frontend",
  "version": "1.0.0",
  "scripts": {
    "build": "mkdir -p dist && echo '<h1>ä¸´æ—¶é‚®ç®±ç³»ç»Ÿ</h1><p>æœåŠ¡æ­£å¸¸è¿è¡Œ</p>' > dist/index.html"
  }
}
EOF
```

### 6.3 å¯åŠ¨æœåŠ¡
```bash
# æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml up -d --build

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f
```

## ğŸ” ç¬¬ä¸ƒæ­¥ï¼šéªŒè¯éƒ¨ç½²

### 7.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€
docker ps

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep -E ':(80|443|8000|9000|2500)'

# æµ‹è¯•HTTPé‡å®šå‘
curl -I http://$DOMAIN

# æµ‹è¯•HTTPSè®¿é—®
curl -I https://$DOMAIN

# æµ‹è¯•API
curl https://$DOMAIN/health
```

### 7.2 è®¾ç½®SSLè¯ä¹¦è‡ªåŠ¨ç»­æœŸ
```bash
# æ·»åŠ è‡ªåŠ¨ç»­æœŸä»»åŠ¡
echo "0 3 1 * * certbot renew --quiet && docker-compose -f ~/temp-email-system/docker-compose.prod.yml restart frontend" | crontab -

# æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
crontab -l
```

## ğŸ‰ å®Œæˆï¼

ç°åœ¨æ‚¨çš„æœåŠ¡åº”è¯¥å¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š

- **ä¸»ç«™**: https://your-domain.com
- **API**: https://your-domain.com/api/
- **å¥åº·æ£€æŸ¥**: https://your-domain.com/health
- **é‚®ä»¶ç®¡ç†**: http://your-domain.com:9000

## ğŸ› ï¸ å¸¸ç”¨ç®¡ç†å‘½ä»¤

```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# é‡å¯æœåŠ¡
docker-compose -f docker-compose.prod.yml restart

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f [service_name]

# åœæ­¢æœåŠ¡
docker-compose -f docker-compose.prod.yml down

# æ›´æ–°æœåŠ¡
docker-compose -f docker-compose.prod.yml pull
docker-compose -f docker-compose.prod.yml up -d --build
```

è¿™ä¸ªéƒ¨ç½²æŒ‡å—è§£å†³äº†æ‰€æœ‰HTTPSä¸‹è½½é—®é¢˜ï¼Œä½¿ç”¨äº†å›½å†…é•œåƒæºï¼Œå¹¶ä¸”é…ç½®äº†å®Œæ•´çš„SSLæ”¯æŒï¼
```
