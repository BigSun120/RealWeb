# æ€§èƒ½ç›‘æ§æ–¹æ¡ˆ

## ä¸€ã€æ–‡æ¡£æ¦‚è¿°
- **æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
- **é€‚ç”¨èŒƒå›´**ï¼šä¸ªäººç½‘ç«™é¡¹ç›®è¿ç»´å›¢é˜Ÿ
- **ç›‘æ§ç›®æ ‡**ï¼šå®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½ã€å¿«é€Ÿå‘ç°é—®é¢˜ã€ä¿éšœæœåŠ¡ç¨³å®š

## äºŒã€ç›‘æ§æ¶æ„è®¾è®¡

### 2.1 ç›‘æ§ä½“ç³»æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åº”ç”¨ç›‘æ§      â”‚    â”‚   åŸºç¡€è®¾æ–½ç›‘æ§   â”‚    â”‚   ä¸šåŠ¡ç›‘æ§      â”‚
â”‚   (APM)        â”‚    â”‚   (Infrastructure)â”‚   â”‚   (Business)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   ç›‘æ§å¹³å°      â”‚
                    â”‚   (Grafana)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   å‘Šè­¦ç³»ç»Ÿ      â”‚
                    â”‚   (AlertManager)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æŠ€æœ¯æ ˆé€‰æ‹©
- **æŒ‡æ ‡æ”¶é›†**ï¼šPrometheus
- **æ—¥å¿—æ”¶é›†**ï¼šELK Stack (Elasticsearch + Logstash + Kibana)
- **å¯è§†åŒ–**ï¼šGrafana
- **å‘Šè­¦**ï¼šAlertManager + é’‰é’‰/é‚®ä»¶
- **é“¾è·¯è¿½è¸ª**ï¼šJaeger
- **åº”ç”¨ç›‘æ§**ï¼šNode.jsè‡ªå®šä¹‰æŒ‡æ ‡

## ä¸‰ã€åº”ç”¨æ€§èƒ½ç›‘æ§(APM)

### 3.1 Node.jsåº”ç”¨ç›‘æ§
```javascript
// æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶
const prometheus = require('prom-client');

// åˆ›å»ºæŒ‡æ ‡æ”¶é›†å™¨
const httpRequestDuration = new prometheus.Histogram({
  name: 'http_request_duration_seconds',
  help: 'HTTPè¯·æ±‚å“åº”æ—¶é—´',
  labelNames: ['method', 'route', 'status_code'],
  buckets: [0.1, 0.3, 0.5, 0.7, 1, 3, 5, 7, 10]
});

const httpRequestTotal = new prometheus.Counter({
  name: 'http_requests_total',
  help: 'HTTPè¯·æ±‚æ€»æ•°',
  labelNames: ['method', 'route', 'status_code']
});

const activeConnections = new prometheus.Gauge({
  name: 'active_connections',
  help: 'å½“å‰æ´»è·ƒè¿æ¥æ•°'
});

// ç›‘æ§ä¸­é—´ä»¶
const monitoringMiddleware = (req, res, next) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = (Date.now() - start) / 1000;
    const route = req.route ? req.route.path : req.path;
    
    httpRequestDuration
      .labels(req.method, route, res.statusCode)
      .observe(duration);
      
    httpRequestTotal
      .labels(req.method, route, res.statusCode)
      .inc();
  });
  
  next();
};

// åº”ç”¨åˆ°Express
app.use(monitoringMiddleware);

// æš´éœ²æŒ‡æ ‡ç«¯ç‚¹
app.get('/metrics', (req, res) => {
  res.set('Content-Type', prometheus.register.contentType);
  res.end(prometheus.register.metrics());
});
```

### 3.2 æ•°æ®åº“æ€§èƒ½ç›‘æ§
```javascript
// MongoDBç›‘æ§
const mongoose = require('mongoose');

// è¿æ¥æ± ç›‘æ§
const dbConnectionGauge = new prometheus.Gauge({
  name: 'mongodb_connections',
  help: 'MongoDBè¿æ¥æ•°',
  labelNames: ['state']
});

// æŸ¥è¯¢æ€§èƒ½ç›‘æ§
const dbQueryDuration = new prometheus.Histogram({
  name: 'mongodb_query_duration_seconds',
  help: 'MongoDBæŸ¥è¯¢å“åº”æ—¶é—´',
  labelNames: ['collection', 'operation'],
  buckets: [0.01, 0.05, 0.1, 0.3, 0.5, 1, 3, 5]
});

// ç›‘æ§æŸ¥è¯¢æ€§èƒ½
mongoose.set('debug', (collectionName, method, query, doc) => {
  const start = Date.now();
  
  // è®°å½•æŸ¥è¯¢å¼€å§‹
  process.nextTick(() => {
    const duration = (Date.now() - start) / 1000;
    dbQueryDuration
      .labels(collectionName, method)
      .observe(duration);
  });
});

// å®šæœŸæ”¶é›†è¿æ¥æ± çŠ¶æ€
setInterval(() => {
  const connections = mongoose.connection.db.serverConfig.connections();
  dbConnectionGauge.labels('available').set(connections.available);
  dbConnectionGauge.labels('used').set(connections.used);
}, 30000);
```

### 3.3 Redisæ€§èƒ½ç›‘æ§
```javascript
// Redisç›‘æ§
const redis = require('redis');
const client = redis.createClient();

const redisCommandDuration = new prometheus.Histogram({
  name: 'redis_command_duration_seconds',
  help: 'Rediså‘½ä»¤å“åº”æ—¶é—´',
  labelNames: ['command'],
  buckets: [0.001, 0.005, 0.01, 0.05, 0.1, 0.3, 0.5, 1]
});

const redisConnectionGauge = new prometheus.Gauge({
  name: 'redis_connections',
  help: 'Redisè¿æ¥æ•°'
});

// åŒ…è£…Rediså‘½ä»¤
const originalSend = client.send_command;
client.send_command = function(command, args, callback) {
  const start = Date.now();
  
  const wrappedCallback = function(...callbackArgs) {
    const duration = (Date.now() - start) / 1000;
    redisCommandDuration.labels(command).observe(duration);
    
    if (callback) {
      callback.apply(this, callbackArgs);
    }
  };
  
  return originalSend.call(this, command, args, wrappedCallback);
};
```

## å››ã€åŸºç¡€è®¾æ–½ç›‘æ§

### 4.1 ç³»ç»Ÿèµ„æºç›‘æ§
```yaml
# Prometheusé…ç½® (prometheus.yml)
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

scrape_configs:
  # Node Exporter (ç³»ç»ŸæŒ‡æ ‡)
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']
    scrape_interval: 15s
    
  # åº”ç”¨æŒ‡æ ‡
  - job_name: 'personal-website'
    static_configs:
      - targets: ['localhost:8000']
    metrics_path: '/metrics'
    scrape_interval: 15s
    
  # MongoDB Exporter
  - job_name: 'mongodb'
    static_configs:
      - targets: ['localhost:9216']
    scrape_interval: 30s
    
  # Redis Exporter
  - job_name: 'redis'
    static_configs:
      - targets: ['localhost:9121']
    scrape_interval: 30s

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - alertmanager:9093
```

### 4.2 å‘Šè­¦è§„åˆ™é…ç½®
```yaml
# alert_rules.yml
groups:
  - name: system_alerts
    rules:
      # CPUä½¿ç”¨ç‡å‘Šè­¦
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPUä½¿ç”¨ç‡è¿‡é«˜"
          description: "å®ä¾‹ {{ $labels.instance }} CPUä½¿ç”¨ç‡è¶…è¿‡80%ï¼Œå½“å‰å€¼: {{ $value }}%"
      
      # å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
      - alert: HighMemoryUsage
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
          description: "å®ä¾‹ {{ $labels.instance }} å†…å­˜ä½¿ç”¨ç‡è¶…è¿‡85%ï¼Œå½“å‰å€¼: {{ $value }}%"
      
      # ç£ç›˜ç©ºé—´å‘Šè­¦
      - alert: HighDiskUsage
        expr: (1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)) * 100 > 90
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "ç£ç›˜ç©ºé—´ä¸è¶³"
          description: "å®ä¾‹ {{ $labels.instance }} ç£ç›˜ä½¿ç”¨ç‡è¶…è¿‡90%ï¼Œå½“å‰å€¼: {{ $value }}%"

  - name: application_alerts
    rules:
      # HTTPé”™è¯¯ç‡å‘Šè­¦
      - alert: HighErrorRate
        expr: rate(http_requests_total{status_code=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100 > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "HTTPé”™è¯¯ç‡è¿‡é«˜"
          description: "5xxé”™è¯¯ç‡è¶…è¿‡5%ï¼Œå½“å‰å€¼: {{ $value }}%"
      
      # å“åº”æ—¶é—´å‘Šè­¦
      - alert: HighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "å“åº”æ—¶é—´è¿‡é•¿"
          description: "95%åˆ†ä½å“åº”æ—¶é—´è¶…è¿‡2ç§’ï¼Œå½“å‰å€¼: {{ $value }}ç§’"
      
      # æ•°æ®åº“è¿æ¥å‘Šè­¦
      - alert: DatabaseConnectionHigh
        expr: mongodb_connections{state="used"} / mongodb_connections{state="available"} * 100 > 80
        for: 3m
        labels:
          severity: warning
        annotations:
          summary: "æ•°æ®åº“è¿æ¥ä½¿ç”¨ç‡è¿‡é«˜"
          description: "MongoDBè¿æ¥ä½¿ç”¨ç‡è¶…è¿‡80%ï¼Œå½“å‰å€¼: {{ $value }}%"
```

## äº”ã€æ—¥å¿—ç›‘æ§

### 5.1 æ—¥å¿—æ”¶é›†é…ç½®
```javascript
// Winstonæ—¥å¿—é…ç½®
const winston = require('winston');
const { ElasticsearchTransport } = require('winston-elasticsearch');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: {
    service: 'personal-website',
    version: process.env.APP_VERSION || '1.0.0'
  },
  transports: [
    // æ§åˆ¶å°è¾“å‡º
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      )
    }),
    
    // æ–‡ä»¶è¾“å‡º
    new winston.transports.File({
      filename: 'logs/error.log',
      level: 'error',
      maxsize: 10485760, // 10MB
      maxFiles: 5
    }),
    
    new winston.transports.File({
      filename: 'logs/combined.log',
      maxsize: 10485760,
      maxFiles: 10
    }),
    
    // Elasticsearchè¾“å‡º
    new ElasticsearchTransport({
      level: 'info',
      clientOpts: {
        node: process.env.ELASTICSEARCH_URL || 'http://localhost:9200'
      },
      index: 'personal-website-logs'
    })
  ]
});

// ç»“æ„åŒ–æ—¥å¿—è®°å½•
const logRequest = (req, res, next) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - start;
    
    logger.info('HTTP Request', {
      method: req.method,
      url: req.url,
      statusCode: res.statusCode,
      duration,
      userAgent: req.get('User-Agent'),
      ip: req.ip,
      userId: req.user?.id
    });
  });
  
  next();
};

module.exports = { logger, logRequest };
```

### 5.2 é”™è¯¯æ—¥å¿—ç›‘æ§
```javascript
// é”™è¯¯å¤„ç†ä¸­é—´ä»¶
const errorHandler = (err, req, res, next) => {
  // è®°å½•é”™è¯¯æ—¥å¿—
  logger.error('Application Error', {
    error: {
      message: err.message,
      stack: err.stack,
      name: err.name
    },
    request: {
      method: req.method,
      url: req.url,
      headers: req.headers,
      body: req.body,
      params: req.params,
      query: req.query
    },
    user: req.user?.id,
    timestamp: new Date().toISOString()
  });
  
  // å‘é€é”™è¯¯å“åº”
  res.status(err.statusCode || 500).json({
    code: err.statusCode || 500,
    message: process.env.NODE_ENV === 'production' 
      ? 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯' 
      : err.message
  });
};

// æœªæ•è·å¼‚å¸¸å¤„ç†
process.on('uncaughtException', (err) => {
  logger.error('Uncaught Exception', {
    error: {
      message: err.message,
      stack: err.stack
    },
    timestamp: new Date().toISOString()
  });
  
  // ä¼˜é›…å…³é—­
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  logger.error('Unhandled Rejection', {
    reason,
    promise,
    timestamp: new Date().toISOString()
  });
});
```

## å…­ã€ä¸šåŠ¡ç›‘æ§

### 6.1 ç”¨æˆ·è¡Œä¸ºç›‘æ§
```javascript
// ç”¨æˆ·è¡Œä¸ºè¿½è¸ª
const trackUserAction = (action, userId, metadata = {}) => {
  logger.info('User Action', {
    action,
    userId,
    metadata,
    timestamp: new Date().toISOString(),
    type: 'USER_BEHAVIOR'
  });
  
  // å‘é€åˆ°åˆ†æç³»ç»Ÿ
  analytics.track(userId, action, metadata);
};

// ä¸šåŠ¡æŒ‡æ ‡æ”¶é›†
const businessMetrics = {
  // ç”¨æˆ·æ³¨å†Œ
  userRegistration: new prometheus.Counter({
    name: 'user_registrations_total',
    help: 'ç”¨æˆ·æ³¨å†Œæ€»æ•°'
  }),
  
  // æ–‡ç« å‘å¸ƒ
  articlePublished: new prometheus.Counter({
    name: 'articles_published_total',
    help: 'æ–‡ç« å‘å¸ƒæ€»æ•°'
  }),
  
  // æ¸¸æˆæ¸¸ç©
  gamePlay: new prometheus.Counter({
    name: 'game_plays_total',
    help: 'æ¸¸æˆæ¸¸ç©æ¬¡æ•°',
    labelNames: ['game_id']
  }),
  
  // åœ¨çº¿ç”¨æˆ·æ•°
  onlineUsers: new prometheus.Gauge({
    name: 'online_users',
    help: 'å½“å‰åœ¨çº¿ç”¨æˆ·æ•°'
  })
};

// ä½¿ç”¨ç¤ºä¾‹
app.post('/api/auth/register', async (req, res) => {
  try {
    const user = await userService.createUser(req.body);
    
    // è®°å½•ä¸šåŠ¡æŒ‡æ ‡
    businessMetrics.userRegistration.inc();
    trackUserAction('user_register', user.id, {
      email: user.email,
      source: req.get('Referer')
    });
    
    res.json({ code: 200, data: user });
  } catch (error) {
    next(error);
  }
});
```

### 6.2 æ€§èƒ½æŒ‡æ ‡ç›‘æ§
```javascript
// è‡ªå®šä¹‰æ€§èƒ½æŒ‡æ ‡
const performanceMetrics = {
  // æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
  dbQueryPerformance: new prometheus.Histogram({
    name: 'db_query_performance_seconds',
    help: 'æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½',
    labelNames: ['operation', 'collection'],
    buckets: [0.01, 0.05, 0.1, 0.3, 0.5, 1, 3, 5]
  }),
  
  // ç¼“å­˜å‘½ä¸­ç‡
  cacheHitRate: new prometheus.Gauge({
    name: 'cache_hit_rate',
    help: 'ç¼“å­˜å‘½ä¸­ç‡',
    labelNames: ['cache_type']
  }),
  
  // æ–‡ä»¶ä¸Šä¼ æ€§èƒ½
  fileUploadDuration: new prometheus.Histogram({
    name: 'file_upload_duration_seconds',
    help: 'æ–‡ä»¶ä¸Šä¼ è€—æ—¶',
    labelNames: ['file_type'],
    buckets: [0.1, 0.5, 1, 3, 5, 10, 30]
  })
};

// ç¼“å­˜ç›‘æ§è£…é¥°å™¨
const monitorCache = (cacheType) => {
  return (target, propertyName, descriptor) => {
    const method = descriptor.value;
    
    descriptor.value = async function(...args) {
      const start = Date.now();
      let hit = false;
      
      try {
        const result = await method.apply(this, args);
        hit = result !== null && result !== undefined;
        return result;
      } finally {
        const duration = (Date.now() - start) / 1000;
        performanceMetrics.cacheHitRate
          .labels(cacheType)
          .set(hit ? 1 : 0);
      }
    };
    
    return descriptor;
  };
};
```

## ä¸ƒã€ç›‘æ§ä»ªè¡¨æ¿

### 7.1 Grafanaä»ªè¡¨æ¿é…ç½®
```json
{
  "dashboard": {
    "title": "ä¸ªäººç½‘ç«™ç›‘æ§ä»ªè¡¨æ¿",
    "panels": [
      {
        "title": "HTTPè¯·æ±‚QPS",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "{{method}} {{route}}"
          }
        ]
      },
      {
        "title": "å“åº”æ—¶é—´åˆ†å¸ƒ",
        "type": "heatmap",
        "targets": [
          {
            "expr": "rate(http_request_duration_seconds_bucket[5m])",
            "legendFormat": "{{le}}"
          }
        ]
      },
      {
        "title": "é”™è¯¯ç‡",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(http_requests_total{status_code=~\"5..\"}[5m]) / rate(http_requests_total[5m]) * 100",
            "legendFormat": "5xxé”™è¯¯ç‡"
          }
        ]
      },
      {
        "title": "ç³»ç»Ÿèµ„æºä½¿ç”¨ç‡",
        "type": "graph",
        "targets": [
          {
            "expr": "100 - (avg(irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)",
            "legendFormat": "CPUä½¿ç”¨ç‡"
          },
          {
            "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100",
            "legendFormat": "å†…å­˜ä½¿ç”¨ç‡"
          }
        ]
      }
    ]
  }
}
```

## å…«ã€å‘Šè­¦é€šçŸ¥

### 8.1 AlertManageré…ç½®
```yaml
# alertmanager.yml
global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@example.com'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'

receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://localhost:3001/webhook/dingtalk'
        send_resolved: true
    
  - name: 'email'
    email_configs:
      - to: 'admin@example.com'
        subject: 'ã€å‘Šè­¦ã€‘{{ .GroupLabels.alertname }}'
        body: |
          {{ range .Alerts }}
          å‘Šè­¦åç§°: {{ .Annotations.summary }}
          å‘Šè­¦è¯¦æƒ…: {{ .Annotations.description }}
          å‘Šè­¦æ—¶é—´: {{ .StartsAt }}
          {{ end }}

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'dev', 'instance']
```

### 8.2 é’‰é’‰å‘Šè­¦é›†æˆ
```javascript
// é’‰é’‰Webhookå‘Šè­¦
const axios = require('axios');

const sendDingTalkAlert = async (alerts) => {
  const webhook = process.env.DINGTALK_WEBHOOK;
  
  for (const alert of alerts) {
    const message = {
      msgtype: 'markdown',
      markdown: {
        title: `ã€${alert.status === 'firing' ? 'å‘Šè­¦' : 'æ¢å¤'}ã€‘${alert.labels.alertname}`,
        text: `
### ${alert.status === 'firing' ? 'ğŸš¨ å‘Šè­¦' : 'âœ… æ¢å¤'}: ${alert.labels.alertname}

**å‘Šè­¦è¯¦æƒ…**: ${alert.annotations.description}

**å‘Šè­¦æ—¶é—´**: ${new Date(alert.startsAt).toLocaleString()}

**å®ä¾‹**: ${alert.labels.instance}

**ä¸¥é‡ç¨‹åº¦**: ${alert.labels.severity}
        `
      }
    };
    
    try {
      await axios.post(webhook, message);
    } catch (error) {
      console.error('å‘é€é’‰é’‰å‘Šè­¦å¤±è´¥:', error);
    }
  }
};

// Webhookæ¥æ”¶ç«¯ç‚¹
app.post('/webhook/dingtalk', (req, res) => {
  const { alerts } = req.body;
  
  if (alerts && alerts.length > 0) {
    sendDingTalkAlert(alerts);
  }
  
  res.status(200).send('OK');
});
```

## ä¹ã€ç›‘æ§è¿ç»´

### 9.1 ç›‘æ§ç³»ç»Ÿéƒ¨ç½²
```yaml
# docker-compose.monitoring.yml
version: '3.8'
services:
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./alert_rules.yml:/etc/prometheus/alert_rules.yml
    
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
    volumes:
      - grafana_data:/var/lib/grafana
    
  alertmanager:
    image: prom/alertmanager:latest
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
    
  node-exporter:
    image: prom/node-exporter:latest
    ports:
      - "9100:9100"
    
  elasticsearch:
    image: elasticsearch:7.14.0
    environment:
      - discovery.type=single-node
    ports:
      - "9200:9200"
    
  kibana:
    image: kibana:7.14.0
    ports:
      - "5601:5601"
    depends_on:
      - elasticsearch

volumes:
  grafana_data:
```

### 9.2 ç›‘æ§æ•°æ®å¤‡ä»½
```bash
#!/bin/bash
# backup_monitoring.sh

# å¤‡ä»½Prometheusæ•°æ®
docker exec prometheus tar -czf /tmp/prometheus_backup.tar.gz /prometheus

# å¤‡ä»½Grafanaé…ç½®
docker exec grafana tar -czf /tmp/grafana_backup.tar.gz /var/lib/grafana

# ä¸Šä¼ åˆ°äº‘å­˜å‚¨
aws s3 cp /tmp/prometheus_backup.tar.gz s3://monitoring-backup/$(date +%Y%m%d)/
aws s3 cp /tmp/grafana_backup.tar.gz s3://monitoring-backup/$(date +%Y%m%d)/

# æ¸…ç†æœ¬åœ°å¤‡ä»½æ–‡ä»¶
rm -f /tmp/*_backup.tar.gz
```

## åã€ç›‘æ§ä¼˜åŒ–

### 10.1 æ€§èƒ½ä¼˜åŒ–
- **æŒ‡æ ‡é‡‡é›†é¢‘ç‡**ï¼šæ ¹æ®é‡è¦æ€§è°ƒæ•´é‡‡é›†é—´éš”
- **æ•°æ®ä¿ç•™ç­–ç•¥**ï¼šè®¾ç½®åˆç†çš„æ•°æ®ä¿ç•™æœŸé™
- **æŸ¥è¯¢ä¼˜åŒ–**ï¼šä¼˜åŒ–PrometheusæŸ¥è¯¢è¯­å¥
- **å­˜å‚¨ä¼˜åŒ–**ï¼šä½¿ç”¨æ—¶åºæ•°æ®åº“å‹ç¼©

### 10.2 å‘Šè­¦ä¼˜åŒ–
- **å‘Šè­¦æ”¶æ•›**ï¼šé¿å…å‘Šè­¦é£æš´
- **æ™ºèƒ½å‘Šè­¦**ï¼šåŸºäºå†å²æ•°æ®çš„åŠ¨æ€é˜ˆå€¼
- **å‘Šè­¦åˆ†çº§**ï¼šä¸åŒçº§åˆ«é‡‡ç”¨ä¸åŒé€šçŸ¥æ–¹å¼
- **é™é»˜è§„åˆ™**ï¼šç»´æŠ¤æœŸé—´è‡ªåŠ¨é™é»˜å‘Šè­¦
